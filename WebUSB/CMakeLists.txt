# This file was automagically generated by mbed.org.
# If you would like to add your own targets, create a
# project.cmake file locally in your project directory.

CMAKE_MINIMUM_REQUIRED(VERSION 3.9)
SET(CMAKE_SYSTEM_NAME Generic)
#SET(CMAKE_SYSTEM_PROCESSOR arm)
SET(CMAKE_CROSSCOMPILING TRUE)

# force compiler settings
SET(CMAKE_C_COMPILER_WORKS TRUE)
SET(CMAKE_CXX_COMPILER_WORKS TRUE)

# force cmake compilers
SET(CMAKE_ASM_COMPILER    "arm-none-eabi-gcc")
SET(CMAKE_C_COMPILER      "arm-none-eabi-gcc")
SET(CMAKE_CXX_COMPILER    "arm-none-eabi-g++")
SET(ELF2BIN               "arm-none-eabi-objcopy")


# if the environment does not specify build type, set to Debug
IF(NOT CMAKE_BUILD_TYPE)
  set(CMAKE_BUILD_TYPE "Debug"
        CACHE STRING "Choose the type of build, options are: Debug Release RelWithDebInfo MinSizeRel."
        FORCE)
ENDIF()

# here starts the project
PROJECT(WebUSB C CXX ASM)

# uncomment below to have a verbose build process
#SET(CMAKE_VERBOSE_MAKEFILE ON)

SET(LD_SYS_LIBS "-Wl,--start-group -lstdc++ -lsupc++ -lm -lc -lgcc -lnosys  -Wl,--end-group")

SET(CMAKE_C_FLAGS "-std=gnu99 -Wall -Wextra -Wno-unused-parameter -Wno-missing-field-initializers -fmessage-length=0 -fno-exceptions -fno-builtin -ffunction-sections -fdata-sections -funsigned-char -MMD -fno-delete-null-pointer-checks -fomit-frame-pointer -Os -g1 -mcpu=cortex-m7 -mthumb -mfpu=fpv5-sp-d16 -mfloat-abi=softfp -include mbed_config.h")
SET(CMAKE_CXX_FLAGS "-std=gnu++98 -fno-rtti -Wvla -Wall -Wextra -Wno-unused-parameter -Wno-missing-field-initializers -fmessage-length=0 -fno-exceptions -fno-builtin -ffunction-sections -fdata-sections -funsigned-char -MMD -fno-delete-null-pointer-checks -fomit-frame-pointer -Os -g1 -mcpu=cortex-m7 -mthumb -mfpu=fpv5-sp-d16 -mfloat-abi=softfp  -include mbed_config.h")
SET(CMAKE_ASM_FLAGS "-x assembler-with-cpp -Wall -Wextra -Wno-unused-parameter -Wno-missing-field-initializers -fmessage-length=0 -fno-exceptions -fno-builtin -ffunction-sections -fdata-sections -funsigned-char -MMD -fno-delete-null-pointer-checks -fomit-frame-pointer -Os -g1 -mcpu=cortex-m7 -mthumb -mfpu=fpv5-sp-d16 -mfloat-abi=softfp  -include mbed_config.h")
SET(CMAKE_CXX_LINK_FLAGS "-Wl,--gc-sections -Wl,--wrap,main -Wl,--wrap,__malloc_r -Wl,--wrap,__free_r -Wl,--wrap,__realloc_r -Wl,--wrap,__memalign_r -Wl,--wrap,__calloc_r -Wl,--wrap,exit -Wl,--wrap,atexit -Wl,-n -mcpu=cortex-m7 -mthumb -mfpu=fpv5-sp-d16 -mfloat-abi=softfp ")
SET(CMAKE_CXX_LINK_FLAGS "${CMAKE_CXX_LINK_FLAGS} ${LD_SYS_LIBS} -T ${CMAKE_BINARY_DIR}/WebUSB_pp.link_script.ld")

ADD_DEFINITIONS(
  -DARM_MATH_CM7
  -DDEVICE_ANALOGIN=1
  -DDEVICE_ANALOGOUT=1
  -DDEVICE_CAN=1
  -DDEVICE_FLASH=1
  -DDEVICE_I2C=1
  -DDEVICE_I2CSLAVE=1
  -DDEVICE_I2C_ASYNCH=1
  -DDEVICE_INTERRUPTIN=1
  -DDEVICE_LOWPOWERTIMER=1
  -DDEVICE_PORTIN=1
  -DDEVICE_PORTINOUT=1
  -DDEVICE_PORTOUT=1
  -DDEVICE_PWMOUT=1
  -DDEVICE_RTC=1
  -DDEVICE_SERIAL=1
  -DDEVICE_SERIAL_ASYNCH=1
  -DDEVICE_SLEEP=1
  -DDEVICE_SPI=1
  -DDEVICE_SPISLAVE=1
  -DDEVICE_SPI_ASYNCH=1
  -DDEVICE_STDIO_MESSAGES=1
  -DDEVICE_TRNG=1
  -DFEATURE_LWIP=1
  -DMBED_BUILD_TIMESTAMP=1531180251.04
  -DTARGET_CORTEX
  -DTARGET_CORTEX_M
  -DTARGET_FAMILY_STM32
  -DTARGET_FF_ARDUINO
  -DTARGET_LIKE_CORTEX_M7
  -DTARGET_LIKE_MBED
  -DTARGET_M7
  -DTARGET_NUCLEO_F746ZG
  -DTARGET_RELEASE
  -DTARGET_RTOS_M4_M7
  -DTARGET_STM
  -DTARGET_STM32F7
  -DTARGET_STM32F746
  -DTARGET_STM32F746ZG
  -DTARGET_STM32F746xG
  -DTARGET_UVISOR_UNSUPPORTED
  -DTOOLCHAIN_GCC
  -DTOOLCHAIN_GCC_ARM
  -DTOOLCHAIN_object
  -DTRANSACTION_QUEUE_SIZE_SPI=2
  -DUSBHOST_OTHER
  -D__CMSIS_RTOS
  -D__CORTEX_M7
  -D__FPU_PRESENT=1
  -D__MBED_CMSIS_RTOS_CM
  -D__MBED__=1
  )
INCLUDE_DIRECTORIES(
  WebUSB/WebUSBDevice
  WebUSB/USBSerial
  WebUSB/USBMSD
  WebUSB/USBMIDI
  WebUSB/USBHID
  WebUSB/USBDevice
  WebUSB/USBDFU
  WebUSB/USBAudio
  WebUSB
  .
  
  )

# executable WebUSB
ADD_EXECUTABLE(WebUSB
  /tmp/tmpAi5i7g/mbed_config.h
  WebUSB/USBAudio/USBAudio.cpp
  WebUSB/USBAudio/USBAudio.h
  WebUSB/USBAudio/USBAudio_Types.h
  WebUSB/USBDFU/DFU.h
  WebUSB/USBDFU/USBDFU.cpp
  WebUSB/USBDFU/USBDFU.h
  WebUSB/USBDFU/WebUSBDFU.cpp
  WebUSB/USBDFU/WebUSBDFU.h
  WebUSB/USBDFU/WinUSB.h
  WebUSB/USBDevice/USBDescriptor.h
  WebUSB/USBDevice/USBDevice.cpp
  WebUSB/USBDevice/USBDevice.h
  WebUSB/USBDevice/USBDevice_Types.h
  WebUSB/USBDevice/USBEndpoints.h
  WebUSB/USBDevice/USBEndpoints_STM32F1.h
  WebUSB/USBDevice/USBHAL.h
  WebUSB/USBDevice/USBHAL_STM32F1.cpp
  WebUSB/USBDevice/USBRegs_STM32.h
  WebUSB/USBHID/USBHID.cpp
  WebUSB/USBHID/USBHID.h
  WebUSB/USBHID/USBHID_Types.h
  WebUSB/USBHID/USBKeyboard.cpp
  WebUSB/USBHID/USBKeyboard.h
  WebUSB/USBHID/USBMouse.cpp
  WebUSB/USBHID/USBMouse.h
  WebUSB/USBHID/USBMouseKeyboard.cpp
  WebUSB/USBHID/USBMouseKeyboard.h
  WebUSB/USBMIDI/MIDIMessage.h
  WebUSB/USBMIDI/USBMIDI.cpp
  WebUSB/USBMIDI/USBMIDI.h
  WebUSB/USBMSD/USBMSD.cpp
  WebUSB/USBMSD/USBMSD.h
  WebUSB/USBSerial/CircBuffer.h
  WebUSB/USBSerial/USBCDC.cpp
  WebUSB/USBSerial/USBCDC.h
  WebUSB/USBSerial/USBSerial.cpp
  WebUSB/USBSerial/USBSerial.h
  WebUSB/WebUSBDevice/WebUSB.h
  WebUSB/WebUSBDevice/WebUSBDevice.cpp
  WebUSB/WebUSBDevice/WebUSBDevice.h
  )
SET_TARGET_PROPERTIES(WebUSB PROPERTIES ENABLE_EXPORTS 1)
# add syslibs dependencies to create the correct linker order
TARGET_LINK_LIBRARIES(WebUSB -lstdc++ -lsupc++ -lm -lc -lgcc -lnosys)

add_custom_command(TARGET WebUSB PRE_LINK
                   COMMAND "arm-none-eabi-cpp" -E -P -Wl,--gc-sections -Wl,--wrap,main -Wl,--wrap,_malloc_r -Wl,--wrap,_free_r -Wl,--wrap,_realloc_r -Wl,--wrap,_memalign_r -Wl,--wrap,_calloc_r -Wl,--wrap,exit -Wl,--wrap,atexit -Wl,-n -mcpu=cortex-m7 -mthumb -mfpu=fpv5-sp-d16 -mfloat-abi=softfp None -o ${CMAKE_CURRENT_BINARY_DIR}/WebUSB_pp.link_script.ld
                   WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
                   BYPRODUCTS "${CMAKE_CURRENT_BINARY_DIR}/WebUSB_pp.link_script.ld"
                   )

add_custom_command(TARGET WebUSB POST_BUILD
                   COMMAND ${ELF2BIN} -O ihex $<TARGET_FILE:WebUSB> $<TARGET_FILE:WebUSB>.hex
                   COMMAND ${CMAKE_COMMAND} -E echo "-- built: $<TARGET_FILE:WebUSB>.hex"
                  )


##########################################################################
# mbed-cli specific targets
##########################################################################

# detect the build type and select the corresponding cli profile
SET(MBED_BUILD_PROFILE "")
STRING(TOLOWER ${CMAKE_BUILD_TYPE} LOWERCASE_CMAKE_BUILD_TYPE)
IF(LOWERCASE_CMAKE_BUILD_TYPE MATCHES debug)
    SET(MBED_BUILD_PROFILE "mbed-os/tools/profiles/debug.json")
ELSEIF(LOWERCASE_CMAKE_BUILD_TYPE MATCHES relwithdebinfo)
    SET(MBED_BUILD_PROFILE "mbed-os/tools/profiles/develop.json")
ELSEIF(LOWERCASE_CMAKE_BUILD_TYPE MATCHES release)
    SET(MBED_BUILD_PROFILE "mbed-os/tools/profiles/release.json")
ELSEIF(LOWERCASE_CMAKE_BUILD_TYPE MATCHES minsizerel)
    SET(MBED_BUILD_PROFILE "mbed-os/tools/profiles/release.json")
ELSE()
  MESSAGE(WARNING "Build type '${CMAKE_BUILD_TYPE}' is unknown, using debug profile")
  SET(MBED_BUILD_PROFILE "mbed-os/tools/profiles/debug.json")
ENDIF()

# optional custom target to build via mbed-cli
ADD_CUSTOM_TARGET(mbed-cli-build
        COMMAND ${CMAKE_COMMAND} -E echo "mbed compile --build BUILD/${CMAKE_BUILD_TYPE} --profile ${MBED_BUILD_PROFILE}"
        COMMAND mbed compile --build BUILD/${CMAKE_BUILD_TYPE} --profile ${MBED_BUILD_PROFILE}
        WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
        SOURCES ${SOURCE_FILES} ${SYS_SOURCE_FILES})

IF(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/project.cmake)
  INCLUDE(${CMAKE_CURRENT_SOURCE_DIR}/project.cmake)
ELSE()
  MESSAGE(STATUS "Add a local project.cmake file to add your own targets.")
ENDIF()

# this will take care of binary directories generated by cmake/clion not to confuse the cli build
FILE(GENERATE OUTPUT "${CMAKE_BINARY_DIR}/.mbedignore" CONTENT "*")